<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 15px; margin: 5px; }
        input { padding: 8px; margin: 5px; width: 200px; }
        #result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
    </style>
</head>
<body>
    <h1>前端認證功能測試</h1>
    
    <div class="test-section">
        <h2>註冊測試</h2>
        <input type="text" id="reg-username" placeholder="用戶名" value="測試用戶2">
        <input type="email" id="reg-email" placeholder="Email" value="test2@example.com">
        <input type="tel" id="reg-phone" placeholder="手機號碼" value="0987654321">
        <input type="password" id="reg-password" placeholder="密碼" value="password123">
        <button onclick="testRegister()">測試註冊</button>
    </div>
    
    <div class="test-section">
        <h2>登入測試</h2>
        <input type="email" id="login-email" placeholder="Email" value="test@example.com">
        <input type="password" id="login-password" placeholder="密碼" value="password123">
        <button onclick="testLogin()">測試登入</button>
    </div>
    
    <div id="result"></div>

    <script>
        // 複製前端API邏輯
        class TestAPI {
            constructor() {
                this.baseURL = 'http://192.168.0.113:8087/api';
                this.token = localStorage.getItem('authToken');
            }

            setToken(token) {
                this.token = token;
                localStorage.setItem('authToken', token);
            }

            getHeaders() {
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }
                
                return headers;
            }

            async request(endpoint, options = {}) {
                try {
                    const url = `${this.baseURL}${endpoint}`;
                    const config = {
                        headers: this.getHeaders(),
                        ...options
                    };

                    console.log('Making request to:', url, config);
                    const response = await fetch(url, config);
                    
                    const text = await response.text();
                    console.log('Response text:', text);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}, response: ${text}`);
                    }

                    return JSON.parse(text);
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            async login(email, password) {
                return this.post('/users/authenticate', { email, password });
            }

            async register(userData) {
                return this.post('/users', userData);
            }
        }

        const api = new TestAPI();

        async function testRegister() {
            const result = document.getElementById('result');
            try {
                const userData = {
                    username: document.getElementById('reg-username').value,
                    email: document.getElementById('reg-email').value,
                    phoneNumber: document.getElementById('reg-phone').value,
                    password: document.getElementById('reg-password').value,
                    role: 'CUSTOMER'
                };
                
                console.log('Registering user:', userData);
                const response = await api.register(userData);
                
                result.innerHTML = '<div class="success">註冊成功！<br>' + JSON.stringify(response, null, 2) + '</div>';
            } catch (error) {
                result.innerHTML = '<div class="error">註冊失敗：' + error.message + '</div>';
            }
        }

        async function testLogin() {
            const result = document.getElementById('result');
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                console.log('Logging in user:', email);
                const response = await api.login(email, password);
                
                if (response.token) {
                    api.setToken(response.token);
                }
                
                result.innerHTML = '<div class="success">登入成功！<br>' + JSON.stringify(response, null, 2) + '</div>';
            } catch (error) {
                result.innerHTML = '<div class="error">登入失敗：' + error.message + '</div>';
            }
        }

        // 頁面加載時測試API連通性
        window.onload = async function() {
            try {
                const response = await fetch('http://192.168.0.113:8087/api/health');
                const data = await response.text();
                console.log('Health check response:', data);
                document.getElementById('result').innerHTML = '<div class="success">API服務器連接正常</div>';
            } catch (error) {
                document.getElementById('result').innerHTML = '<div class="error">無法連接到API服務器：' + error.message + '</div>';
            }
        };
    </script>
</body>
</html>